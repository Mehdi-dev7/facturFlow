generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum BusinessType {
  WEB_DEV
  DESIGN
  CONSULTING
  CONSTRUCTION
  PHOTOGRAPHY
  WRITING
  COACHING
  ECOMMERCE
  SERVICES
  OTHER
}

enum ClientType {
  COMPANY
  INDIVIDUAL
}

enum ProductType {
  SERVICE
  PRODUCT
}

enum DocumentType {
  INVOICE
  QUOTE
  DEPOSIT
  CREDIT_NOTE
  PURCHASE_ORDER
  DELIVERY_NOTE
  RECEIPT
  PROFORMA
  CONTRACT
}

enum DocumentStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  REJECTED
  PAID
  PARTIALLY_PAID
  OVERDUE
  REMINDED
  CANCELLED
}

enum RecurringFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  SEMIYEARLY
  YEARLY
  CUSTOM
}

enum ReminderLevel {
  FRIENDLY
  FIRM
  FORMAL
}

// ============================================
// MODELS
// ============================================

model User {
  id            String    @id
  email         String    @unique
  emailVerified Boolean   @default(false)
  name          String
  image         String?

  // Better Auth relations
  sessions Session[]
  accounts Account[]

  // Company Information
  companyName       String?
  companySiret      String?
  companySiren      String?
  companyVatNumber  String?
  companyAddress    String?
  companyPostalCode String?
  companyCity       String?
  companyCountry    String?  @default("France")
  companyPhone      String?
  companyEmail      String?
  companyWebsite    String?
  companyLogo       String?

  // Business Type
  businessType BusinessType?

  // Banking
  iban String?
  bic  String?

  // Settings
  currency String @default("EUR")
  locale   String @default("fr-FR")
  timezone String @default("Europe/Paris")

  // Invoice Settings
  invoicePrefix     String @default("INV")
  quotePrefix       String @default("QUO")
  creditNotePrefix  String @default("CN")
  nextInvoiceNumber Int    @default(1)
  nextQuoteNumber   Int    @default(1)
  nextCreditNumber  Int    @default(1)
  nextDepositNumber Int    @default(1)

  // Payment Terms
  defaultPaymentTerms  Int      @default(30)
  defaultPaymentMethod String?
  lateFeesPercentage   Decimal  @default(0) @db.Decimal(5, 2)

  // Relations
  clients   Client[]
  products  Product[]
  documents Document[]
  templates Template[]
  recurring RecurringInvoice[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Session {
  id        String   @id
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
}

model Account {
  id                    String    @id
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@index([identifier])
}

model Client {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Type
  type ClientType

  // Company Fields (B2B)
  companyName      String?
  companySiret     String?
  companySiren     String?
  companyVatNumber String?

  // Individual Fields (B2C)
  firstName String?
  lastName  String?

  // Contact
  email String
  phone String?

  // Address
  address      String?
  addressLine2 String?
  postalCode   String?
  city         String?
  country      String? @default("France")

  // Notes
  notes String? @db.Text

  // Statistics
  totalInvoiced Decimal @default(0) @db.Decimal(12, 2)
  totalPaid     Decimal @default(0) @db.Decimal(12, 2)

  // Relations
  documents Document[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([email])
}

model Product {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Info
  name        String
  description String? @db.Text

  // Type
  type ProductType

  // Pricing
  unitPrice Decimal @db.Decimal(12, 2)
  unit      String  @default("unité")
  vatRate   Decimal @default(20.00) @db.Decimal(5, 2)

  // Stock (optional)
  sku        String?
  stock      Int?
  trackStock Boolean @default(false)

  // Relations
  lineItems DocumentLineItem[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Document {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Type
  type DocumentType

  // Numbering
  number String

  // Client
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Dates
  date       DateTime  @default(now())
  dueDate    DateTime?
  validUntil DateTime? // Pour devis

  // Status
  status DocumentStatus

  // Amounts
  subtotal Decimal  @db.Decimal(12, 2)
  taxTotal Decimal  @db.Decimal(12, 2)
  total    Decimal  @db.Decimal(12, 2)
  discount Decimal? @db.Decimal(12, 2)

  // Payment
  paidAmount    Decimal   @default(0) @db.Decimal(12, 2)
  paidAt        DateTime?
  paymentMethod String?

  // Content
  title  String?
  notes  String? @db.Text
  footer String? @db.Text

  // Template
  templateId String?
  template   Template? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // Special fields
  depositPercentage Decimal? @db.Decimal(5, 2) // Pour acompte (%)
  depositAmount     Decimal? @db.Decimal(12, 2) // Acompte déjà versé (montant fixe)
  relatedDocumentId String? // Pour liens entre documents
  businessMetadata  Json? // Données métier spécifiques

  // Invoice template type
  invoiceType  String? // "basic" | "freelance_heures" | "freelance_tache" | "artisan" | "ecommerce"

  // Discount type — la valeur est dans le champ discount existant
  discountType String? // "pourcentage" | "montant"

  // Quote validation tokens (type QUOTE uniquement)
  acceptToken String?   @unique
  refuseToken String?   @unique
  respondedAt DateTime?
  clientNote  String?   @db.Text

  // Files
  pdfUrl String?

  // Relations
  lineItems DocumentLineItem[]
  reminders Reminder[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([clientId])
  @@index([number])
  @@index([status])
  @@index([type])
}

model DocumentLineItem {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Product reference
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  // Item details
  description String
  quantity    Decimal @db.Decimal(12, 2)
  unit        String  @default("unité")
  unitPrice   Decimal @db.Decimal(12, 2)

  // Tax
  vatRate Decimal @db.Decimal(5, 2)

  // Discount
  discount Decimal? @db.Decimal(12, 2)

  // Category (artisan: "main_oeuvre" | "materiel")
  category String?

  // Totals
  subtotal  Decimal @db.Decimal(12, 2)
  taxAmount Decimal @db.Decimal(12, 2)
  total     Decimal @db.Decimal(12, 2)

  // Order
  order Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([documentId])
}

model RecurringInvoice {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Client
  clientId String

  // Schedule
  frequency RecurringFrequency
  startDate DateTime
  endDate   DateTime?
  nextDate  DateTime

  // Status
  active Boolean @default(true)

  // Template data
  templateData Json

  // Statistics
  invoiceCount Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([active])
  @@index([nextDate])
}

model Template {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Info
  name        String
  description String?

  // Type
  type         DocumentType
  businessType BusinessType?

  // Design
  isDefault Boolean @default(false)
  isPremium Boolean @default(false)

  // Template data
  design Json

  // Preview
  thumbnail String?

  // Relations
  documents Document[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([businessType])
}

model Reminder {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Type
  level ReminderLevel

  // Status
  sent   Boolean   @default(false)
  sentAt DateTime?

  // Schedule
  scheduledFor DateTime

  // Content
  subject String
  message String @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([documentId])
  @@index([sent])
  @@index([scheduledFor])
}
